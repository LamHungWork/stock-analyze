flowchart TD
    CLI1(["`**python main.py**
    Daily Analysis`"])
    CLI2(["`**python simulate.py**
    Historical Simulation`"])

    subgraph DATA["ðŸ“¦ Data Layer"]
        DM["data_manager.py
        download_and_save()
        load_local()"]
        DF["data_fetcher.py
        fetch_ohlcv()"]
        CSV_DATA[("data/HPG.csv
        OHLCV cache")]
        VNC["ðŸŒ vnstock VCI"]
        YF["ðŸŒ yfinance .VN"]
    end

    subgraph ANALYSIS["ðŸ”¬ Analysis Layer (Phase 1)"]
        TA["technical_analysis.py
        SMA20, Volume, Swing, Fibonacci"]
        PRED["predictor.py
        predict() â†’ trend/target/SL/RR
        recommend_t_plus() â†’ T+3/4/5"]
    end

    subgraph STRAT["â™Ÿï¸ Strategy Framework (Phase 2)"]
        BASE["strategies/base.py
        BaseStrategy (abstract)
        generate_signal(df) â†’ dict"]
        S1["SmaFibonacciStrategy
        SMA20 + Fibonacci
        â† baseline"]
        S2["MacdStrategy
        MACD 12,26,9
        golden/death cross"]
        S3["RsiSmaStrategy
        RSI14 + SMA50
        oversold/overbought"]
        S4["BollingerStrategy
        BB 20,2
        mean-reversion"]
        BASE --> S1 & S2 & S3 & S4
    end

    subgraph SIM["âš™ï¸ Simulation Engine (Phase 2)"]
        SIMU["simulator.py
        run_simulation()"]
        EVAL["evaluator.py
        evaluate_all_strategies()
        load_monthly_summary()"]
        NOTE1["No-lookahead rule:
        signal = df[:d+1]
        entry = open[d+1]
        exit = TP / SL / T+ expire"]
    end

    subgraph OUT["ðŸ“Š Output Layer"]
        RPGEN["report_generator.py
        Section 1-4 (Phase 1)
        Section 5: P&L sim table
        Section 6: Monthly summary"]
        MD[("reports/HPG/
        2026-02-25.md")]
        SUMCSV[("SUMMARY_REPORT.csv")]
        TRADESCSV[("SIMULATION_TRADES.csv
        every trade detail")]
        CMPCSV[("STRATEGY_COMPARISON.csv
        ranked by Total PnL")]
    end

    subgraph TPLUS["ðŸ“… T+ Recommendation Logic"]
        TP1["RR > 2.0 AND volume spike â†’ T+3"]
        TP2["RR â‰¥ 1.5 â†’ T+4"]
        TP3["RR < 1.5 â†’ T+5"]
    end

    CLI1 --> DF
    CLI2 --> DM

    DM --> VNC & YF
    DM <--> CSV_DATA
    DF --> VNC & YF

    DF --> TA --> PRED --> RPGEN
    RPGEN --> MD & SUMCSV

    DM --> STRAT
    S1 -.-> TA & PRED
    STRAT --> SIMU
    SIMU --> EVAL
    EVAL --> TRADESCSV & CMPCSV
    EVAL -.->|"monthly data"| RPGEN

    NOTE1 -. governs .-> SIMU

    PRED --> TPLUS
    TPLUS --> SIMU

    style DATA fill:#e8f4f8,stroke:#2196F3
    style ANALYSIS fill:#f3e8ff,stroke:#9C27B0
    style STRAT fill:#fff8e1,stroke:#FF9800
    style SIM fill:#e8f5e9,stroke:#4CAF50
    style OUT fill:#fce4ec,stroke:#E91E63
    style TPLUS fill:#fffde7,stroke:#FFC107
    style NOTE1 fill:#f5f5f5,stroke:#9E9E9E,color:#555
    style CLI1 fill:#1565C0,color:#fff
    style CLI2 fill:#2E7D32,color:#fff
